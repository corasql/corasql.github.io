# OpenSSL TLS心跳扩展协议包远程信息泄露漏洞 (CVE-2014-0160)及nginx编译安装

## 1、受影响系统

OpenSSL Project OpenSSL 1.0.2-beta1  
OpenSSL Project OpenSSL 1.0.2-beta  
OpenSSL Project OpenSSL 1.0.1f    
OpenSSL Project OpenSSL 1.0.1e  
OpenSSL Project OpenSSL 1.0.1d  
OpenSSL Project OpenSSL 1.0.1c  
OpenSSL Project OpenSSL 1.0.1b  
OpenSSL Project OpenSSL 1.0.1a  
OpenSSL Project OpenSSL 1.0.1  

## 2、不受影响系统  

OpenSSL Project OpenSSL 1.0.2-beta2  
OpenSSL Project OpenSSL 1.0.1g  
OpenSSL Project OpenSSL 1.0.0  
OpenSSL Project OpenSSL 0.9.8  

## 3、描述  

BUGTRAQ  ID: 66690  
CVE(CAN) ID: CVE-2014-0160  

OpenSSL是一种开放源码的SSL实现，用来实现网络通信的高强度加密，现在被广泛地用于各种网络应用程序中。  

OpenSSL TLS心跳扩展协议的实现上存在边界检查漏洞，远程无需验证的攻击者可以利用此漏洞导致泄漏64K的内存到连接的客户端或服务器，造成敏感信息的泄露。仅OpenSSL的1.0.1及1.0.2-beta版本受到影响，包括：1.0.1f及1.0.2-beta1版本。  

TLS心跳由一个请求包组成，其中包括有效载荷（payload），通信的另一方将读取这个包并发送一个响应，其中包含同样的载荷。在处理心跳请求的代码中，载荷大小是从攻击者可控的包中读取的。由于OpenSSL并没有检查该载荷大小值，从而导致越界读，造成了敏感信息泄漏。泄漏的信息内容可能会包括加密的私钥和其他敏感信息例如用户名、口令等。


## 4、建议

### 4.1、临时解决方法：

NSFOCUS建议您升级到OpenSSL 1.0.1g。但如果您不能立刻安装补丁或者升级，您可以采取以下措施以降低威胁：

使用-DOPENSSL_NO_HEARTBEATS选项重编译OpenSSL。

### 4.2、厂商补丁：

OpenSSL Project
Openssl已经发布了Openssl 1.0.1g修复此问题，:

厂商安全公告：
https://www.openssl.org/news/secadv_20140407.txt  
http://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=96db9023b881d7cd9f379b0c154650d6c108e9a3

对于OpenSSL 1.0.2 Releases, 厂商表示将会在1.0.2-beta2中修复。

## 5、window nginx OpenSSL 64位编译安装

### 5.1、需要准备的工具：

visual studio 2013  
下载MSYS，地址：https://sourceforge.net/projects/mingw/files/Installer/ 下载mingw-get-setup.exe  
安装perl，ActivePerl https://www.activestate.com/activeperl/downloads  
Mercurial安装包（一个源码管理器：水银）https://www.mercurial-scm.org/  
-PCRE,zlib 和OpenSSL 这三个nginx需要的依赖模块  

### 5.2、安装visual studio 2013

下一步(win安装，就下一步，下一步，就OK了)

### 5.3、安装MSYS

下载mingw-get-setup.exe直接执行直接下一步即可，安装完成之后找到文件bin/mingw-get.exe打开，用这个来安装msys点击左侧的Basic Setup右侧选择mingw32-base和msys.base只有点击菜单isntallation－》Apply Changes 开始下载，完成之后点击左侧All Packages－》MSYS－》MSY Base System检查右侧菜单的选中组件中是否有msys-make、msys-tar因为这两个组件会在接下来用到。

### 5.4、安装ActivePerl

下一步(win安装，就下一步，下一步，就OK了)

### 5.5、安装Mercurial

下一步(win安装，就下一步，下一步，就OK了)
安装目录为：F:\Mercurial\  
环境变量中添加F:\Mercurial\目录，因为我们需要在命令行中使用hg命令来获取nginx的源码。

### 5.6、下载nginx源码和依赖模块

nginx下载目录为：F:\Mercurial\

<pre>
hg clone http://hg.nginx.org/nginx
</pre>

### 5.7、下载nginx-http-concat

在F:\Mercurial\nginx\下建立build目录  
在F:\Mercurial\nginx\build下建立lib目录  
下载nginx-http-concat到F:\Mercurial\nginx\build\lib目录下
<pre>
git clone https://github.com/alibaba/nginx-http-concat.git
</pre>

###  5.8、解压zlib pcre openssl

解压到F:\Mercurial\nginx\build\lib目录下
备注：本实验openssl安装版本为openssl-1.0.2l

### 5.9、在nginx根目录下，创建build.bat文件，文本内容如下：

<pre>
auto/configure --with-cc=cl --builddir=build --prefix= \
--conf-path=conf/nginx.conf --pid-path=logs/nginx.pid \
--http-log-path=logs/access.log --error-log-path=logs/error.log \
--sbin-path=nginx.exe --http-client-body-temp-path=temp/client_body_temp \
--http-proxy-temp-path=temp/proxy_temp \
--http-fastcgi-temp-path=temp/fastcgi_temp \
--with-cc-opt=-DFD_SETSIZE=1024 --with-pcre=build/lib/pcre-8.39 \
--with-zlib=build/lib/zlib-1.2.11 --with-openssl=build/lib/openssl-1.0.2l \
--with-select_module --with-http_ssl_module  \
--with-http_sub_module \
--add-module=build/lib/nginx-http-concat
</pre>

### 5.10、修改makefile.msvc

由于本次实验需要编译的是64位版本openssl，所以需要对makefile.msvc进行修改。  
所在目录为：F:\Mercurial\nginx\auto\lib\openssl
修改内容为：

<pre>
把VC-WIN32修改为VC-WIN64A
把ms\do_ms.bat修改为ms\do_win64a.bat
把ms\do_ms修改为ms\do_win64a
</pre>

以上是编译静态库，如果你想编译动态库，做以下操作：
<pre>
把VC-WIN32修改为VC-WIN64A
把ms\do_ms.bat修改为ms\do_win64a.bat
把ms\do_ms修改为ms\do_win64a
把ms\nt.mak修改为ms\ntdll.mak
</pre>

### 5.11、启动msys.bat,进入nginx根目录，执行

使用管理员权限运行  
<pre>
build.bat
</pre>

### 5.12、编译nginx源代码：

使用管理员权限运行 “VS2013 x64 Native Tools Command Prompt”执行编译：
<pre>
F:\Mercurial\nginx>nmake -f build/Makefile
</pre>

### 5.13、运行nginx -V可以查看编译版支持哪些模块

<pre>
F:\Mercurial\nginx\build>nginx.exe -V
nginx version: nginx/1.13.2
built by cl 18.00.40629 for x64
built with OpenSSL 1.1.0f  25 May 2017
TLS SNI support enabled
configure arguments: --with-cc=cl --builddir=build --prefix= --conf-path=conf/nginx.conf --pid-path=logs/nginx.pid --http-log-path=logs/access.log --error-log-path=logs/error.log --sbin-path=nginx.exe --http-client-body-temp-path=temp/client_body_temp --http-proxy-temp-path=temp/proxy_temp --http-fastcgi-temp-path=temp/fastcgi_temp --with-cc-opt=-DFD_SETSIZE=1024 --with-pcre=build/lib/pcre-8.39 --with-zlib=build/lib/zlib-1.2.11 --with-openssl=build/lib/openssl-1.1.0f --with-select_module --with-http_ssl_module --with-http_sub_module --add-module=build/lib/nginx-http-concat
</pre>

### 5.14、建立相应目录

在F:\Mercurial\nginx\build目录下，建立相应的目录，temp,logs  
把F:\Mercurial\nginx下conf文件，拷贝到build目录下  
在F:\Mercurial\nginx\docs下的html文件中，拷贝到build目录下  

## 6、Windows下Nginx的启动、停止等命令

在Windows下使用Nginx，我们需要掌握一些基本的操作命令，比如：启动、停止Nginx服务，重新载入Nginx等，下面我就进行一些简单的介绍。

### (1)启动

<pre>
F:\Mercurial\nginx\build>start nginx
或
F:\Mercurial\nginx\build>nginx.exe
</pre>

注：建议使用第一种，第二种会使你的cmd窗口一直处于执行中，不能进行其他命令操作。

### (2)停止

<pre>
F:\Mercurial\nginx\build>nginx.exe -s stop
或
F:\Mercurial\nginx\build>nginx.exe -s quit
</pre>

注：stop是快速停止nginx，可能并不保存相关信息；quit是完整有序的停止nginx，并保存相关信息。

### (3)重新载入Nginx

<pre>
F:\Mercurial\nginx\build>nginx.exe -s reload
</pre>

当配置信息修改，需要重新载入这些配置时使用此命令。

### (4)重新打开日志文件：

<pre>
F:\Mercurial\nginx\build>nginx.exe -s reopen
</pre>

### (5)查看Nginx版本：

<pre>
F:\Mercurial\nginx\build>nginx -v
</pre>
